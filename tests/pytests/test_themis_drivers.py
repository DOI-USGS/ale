import pytest
import numpy as np
import os
import unittest
from unittest.mock import PropertyMock, patch

import json

import ale
from ale import util
from ale.drivers.ody_drivers import OdyThemisVisIsisLabelNaifSpiceDriver, OdyThemisIrIsisLabelNaifSpiceDriver

from conftest import get_image_label, get_image_kernels, convert_kernels, compare_dicts


image_dict = {
    "V46475015EDR" : {
        "isis" :
        {"CameraVersion":1,"NaifKeywords":{"BODY499_RADII":[3396.19,3396.19,3376.2],"BODY_FRAME_CODE":10014,"BODY_CODE":499,"INS-53032_TRANSX":[0,0.009,0],"INS-53032_TRANSY":[0,0,-0.009],"FRAME_-53032_CLASS_ID":-53032,"INS-53032_CK_TIME_BIAS":0,"INS-53032_CK_FRAME_ID":-53000,"TKFRAME_-53032_RELATIVE":"M01_THEMIS_OPTICS","FRAME_-53032_NAME":"M01_THEMIS_VIS","TKFRAME_-53032_AXES":[1,2,3],"TKFRAME_-53032_SPEC":"ANGLES","INS-53032_CK_TIME_TOLERANCE":1,"FRAME_-53032_CLASS":4,"INS-53032_PLATFORM_ID":-53000,"INS-53032_ITRANSL":[0,0,-111.11111111],"INS-53032_SPK_TIME_BIAS":0,"INS-53032_ITRANSS":[0,111.11111111,0],"TKFRAME_-53032_ANGLES":[0,90,-0.25],"FRAME_-53032_CENTER":-53,"INS-53032_CK_REFERENCE_ID":16,"TKFRAME_-53032_UNITS":"DEGREES","BODY499_POLE_DEC":[52.8865,-0.0609,0],"BODY499_POLE_RA":[317.68143,-0.1061,0],"BODY499_PM":[176.63,350.89198226,0]},"InstrumentPointing":{"TimeDependentFrames":[-53000,16,1],"CkTableStartTime":392211095.6197291,"CkTableEndTime":392211113.1301291,"CkTableOriginalSize":57,"EphemerisTimes":[392211095.6197291,392211095.9324148,392211096.24510056,392211096.5577862,392211096.87047195,392211097.1831577,392211097.4958434,392211097.8085291,392211098.1212148,392211098.43390054,392211098.74658626,392211099.05927193,392211099.37195766,392211099.6846434,392211099.9973291,392211100.31001484,392211100.6227005,392211100.93538624,392211101.24807197,392211101.5607577,392211101.87344337,392211102.1861291,392211102.4988148,392211102.81150055,392211103.1241862,392211103.43687195,392211103.7495577,392211104.0622434,392211104.3749291,392211104.6876148,392211105.0003005,392211105.31298625,392211105.625672,392211105.93835765,392211106.2510434,392211106.5637291,392211106.87641484,392211107.1891005,392211107.50178623,392211107.81447196,392211108.1271577,392211108.43984336,392211108.7525291,392211109.0652148,392211109.37790054,392211109.69058627,392211110.00327194,392211110.31595767,392211110.6286434,392211110.9413291,392211111.2540148,392211111.5667005,392211111.87938625,392211112.192072,392211112.50475764,392211112.8174434,392211113.1301291],"Quaternions":[[0.622044822044232,0.2555212953329484,0.5142689567685136,-0.5322560916547194],[0.6219721358484464,0.2555931497238939,0.5142326325311447,-0.532341623097828],[0.6218994378122704,0.255664999210369,0.5141962984953437,-0.5324271443505032],[0.6218266220457066,0.2557367157273579,0.5141598825608136,-0.5325129101808341],[0.6217532237605791,0.25580773704181553,0.5141230682224436,-0.5326000386166089],[0.6216798134551098,0.2558787533721587,0.5140862439354403,-0.5326871566984519],[0.6216063910747475,0.2559497647711598,0.514049409672439,-0.5327742644911004],[0.6215329566768979,0.256020771183298,0.5140125654622392,-0.5328613619264488],[0.6214595102349949,0.2560917726342708,0.513975711291514,-0.5329484490360202],[0.6213860517224542,0.25616276914976815,0.5139388471469214,-0.5330355258513224],[0.6213125811967097,0.2562337606742803,0.5139019730572842,-0.5331225923042731],[0.6212390986311821,0.2563047472335,0.5138650890092648,-0.5332096484263846],[0.6211656040272954,0.2563757288260513,0.5138281950035775,-0.5332966942159701],[0.621092097358448,0.25644670547761683,0.5137912910268664,-0.5333837297045222],[0.6210185786821113,0.2565176771327029,0.513754377107985,-0.5334707548239914],[0.6209450479436536,0.256588643844049,0.5137174532195026,-0.5335577696390466],[0.6208715052005654,0.2566596055561691,0.5136805193902885,-0.5336447740816538],[0.6207979504262415,0.25673056229474434,0.5136435756069835,-0.5337317681833034],[0.6207243835940579,0.25680151408544866,0.513606621856213,-0.5338187519754688],[0.6206508047615341,0.2568724608728073,0.5135696581668697,-0.5339057253901413],[0.6205772139020509,0.25694340268249666,0.5135326845255838,-0.5339926884587988],[0.6205036109889719,0.257014339540185,0.51349570091897,-0.5340796412129047],[0.6204299960798443,0.2570852713904092,0.5134587073759441,-0.5341665835844737],[0.6203563902475108,0.2571564725103493,0.5134227775960358,-0.5342523272487295],[0.620282773248645,0.2572276777923829,0.5133868735472037,-0.53433802134785],[0.6202091443605141,0.2572988781827923,0.5133509596675742,-0.5344237052618983],[0.620135503640667,0.25737007362592673,0.5133150359852172,-0.5345093789239032],[0.6200618510343618,0.2574412641747103,0.5132791024734287,-0.5345950423975511],[0.6199881865991661,0.25751244977349996,0.5132431591602945,-0.5346806956158872],[0.6199145103084113,0.2575836304480763,0.5132072060328047,-0.5347663386099336],[0.6198408221354105,0.2576548062242126,0.5131712430779339,-0.5348519714106978],[0.6197671221377594,0.25772597704627703,0.5131352703237914,-0.5349375939512486],[0.6196927011689114,0.2577965482510988,0.5130979380241887,-0.5350256085675931],[0.6196170791966188,0.2578661173963778,0.5130583330559672,-0.5351176389810011],[0.6195414444622597,0.2579356812304656,0.5130187175204376,-0.5352096583727519],[0.6194657969673918,0.2580052397519301,0.512979091418416,-0.5353016667409506],[0.619390136684726,0.2580747929858539,0.512939454735605,-0.5353936641187729],[0.6193144636735102,0.2581443408777712,0.5128998075030438,-0.5354856504341775],[0.6192387779064608,0.25821388345276725,0.5128601497064393,-0.5355776257203454],[0.6191630793562748,0.2582834207359189,0.5128204813314834,-0.5356695900104406],[0.61908736808223,0.25835295267277325,0.5127808024092395,-0.5357615432324476],[0.6190116440570289,0.2584224792884094,0.5127411129254037,-0.5358534854195353],[0.6189371372599068,0.25849312035074623,0.5127036717193411,-0.5359412951596026],[0.6188629665697523,0.2585640732923932,0.5126668599059531,-0.5360279277846458],[0.6187887838478893,0.2586350212459962,0.5126300381348735,-0.5361145500459499],[0.6187145891523202,0.2587059641560827,0.5125932064348925,-0.5362011618757861],[0.6186403824562048,0.2587769020483256,0.5125563647926881,-0.5362877633055009],[0.6185661637609823,0.25884783492134916,0.512519513208975,-0.5363743543334143],[0.6184919330397899,0.2589187628008173,0.512482651670413,-0.5364609349908531],[0.6184176903506672,0.2589896856312731,0.5124457802058235,-0.5365475052101218],[0.6183434356667569,0.2590606034383825,0.51240889880187,-0.5366340650225511],[0.6182691689611832,0.25913151624780373,0.5123720074452016,-0.5367206144594565],[0.6181948902920135,0.2592024240040913,0.512335106164663,-0.5368071534531671],[0.6181205996040526,0.259273326759937,0.5122981949328332,-0.5368936820679884],[0.6180462969553866,0.259344224459902,0.5122612737785727,-0.536980200236266],[0.6179719823191362,0.25941511712964443,0.5122243426885267,-0.5370667079893118],[0.617897655696743,0.2594860047677886,0.5121874016634121,-0.537153205325448]],"AngularVelocity":[[-0.0008105492062180801,-0.00019831431313117837,0.0002945565809147707],[-0.0008107172753508432,-0.00019815565545792442,0.0002948687090577655],[-0.0008112547770582715,-0.00019764825252873363,0.00029586692572633466],[-0.000811763472736369,-0.000197168564245327,0.00029682478562144686],[-0.0008120536102845764,-0.00019689915353384373,0.00029747644982695804],[-0.0008120025147958052,-0.00019695804748847936,0.0002976500531128739],[-0.0008119514193143314,-0.0001970169414347032,0.0002978236563739951],[-0.0008119003238286054,-0.00019707583538582828,0.00029799725964956366],[-0.000811849228350177,-0.00019713472932854213,0.00029817086290033723],[-0.0008117981328687033,-0.0001971936232747663,0.0002983444661614585],[-0.0008117470373799316,-0.0001972525172294018,0.0002985180694473745],[-0.0008116959419075943,-0.00019731141116509474,0.00029869167267745325],[-0.0008116448464291662,-0.0001973703051078083,0.0002988652759282267],[-0.0008115937509476923,-0.00019742919905403231,0.0002990388791893478],[-0.0008115426554589207,-0.00019748809300866794,0.00029921248247526415],[-0.0008114915599774469,-0.00019754698695489205,0.00029938608573638545],[-0.000811440464491721,-0.00019760588090601713,0.00029955968901195396],[-0.0008113893690132926,-0.00019766477484873098,0.0002997332922627275],[-0.0008113382735318189,-0.00019772366879495493,0.00029990689552384856],[-0.0008112871780430475,-0.00019778256274959055,0.00030008049880976464],[-0.0008112360825707103,-0.0001978414566852836,0.00030025410203984333],[-0.0008111849870861905,-0.00019790035063501791,0.00030042770531131204],[-0.000811133891597419,-0.00019795924458965337,0.0003006013085972279],[-0.0008114696582776298,-0.00019773503631344394,0.0003011512696450155],[-0.0008126685954353707,-0.0001968791677121538,0.0003025409637565207],[-0.0008138956886189822,-0.00019600269479172163,0.0003039580494352923],[-0.0008151227819047116,-0.00019512622179834965,0.00030537513523199323],[-0.0008163498750151826,-0.00019424974893015933,0.0003067922208262997],[-0.0008175769682277714,-0.0001933732759890292,0.0003082093065385356],[-0.0008188040612651021,-0.00019249680317308068,0.0003096263920483779],[-0.0008200311543755728,-0.0001916203303048902,0.0003110434776426845],[-0.0008212582476613024,-0.00019074385731151805,0.00031246056343938513],[-0.0008223790044451216,-0.00018994439608103445,0.0003137423873397018],[-0.0008230877864604787,-0.00018944329809780856,0.0003145001720138148],[-0.0008234047853027196,-0.00018922594006077185,0.00031475960156172243],[-0.0008237217841260656,-0.00018900858203669077,0.00031501903109416683],[-0.0008240387829872007,-0.00018879122398669844,0.00031527846065753756],[-0.0008243557818747165,-0.00018857386591861772,0.00031553789024249784],[-0.0008246727807169572,-0.000188356507881581,0.00031579731979040513],[-0.0008249897795780924,-0.00018813914983158847,0.00031605674935377586],[-0.000825306778484503,-0.0001879217917505523,0.0003163161789541995],[-0.0008256237772889547,-0.00018770443373942677,0.0003165756084711806],[-0.0008257598861364749,-0.0001876355310573001,0.00031666644746339116],[-0.0008254471781331976,-0.00018793496971617596,0.0003163389864771291],[-0.0008250219215366936,-0.0001883267763343618,0.0003159066295374425],[-0.0008245966648794524,-0.00018871858300850735,0.00031547427253600445],[-0.0008241714083589903,-0.00018911038955663308,0.0003150419156736289],[-0.0008237461517878334,-0.00018950219615146565,0.0003146095587597125],[-0.0008233208951913293,-0.00018989400276965155,0.00031417720182002587],[-0.0008228956385340888,-0.00019028580944379725,0.00031374484481858816],[-0.0008224703820136267,-0.00019067761599192277,0.0003133124879562125],[-0.0008220451253917753,-0.00019106942263346212,0.00031288013099075527],[-0.0008216198687345342,-0.00019146122930760787,0.00031244777398931745],[-0.00082119461213803,-0.00019185303592579405,0.00031201541704963047],[-0.0008207693555061364,-0.0001922448425765858,0.0003115830600739633],[-0.0008203440989349798,-0.00019263664917141843,0.0003111507031600469],[-0.0008199188423891699,-0.00019302845574289745,0.0003107183462719009]],"ConstantFrames":[-53032,-53030,-53000],"ConstantRotation":[0.0003684744441107557,0.004882317815721682,0.9999880135278275,0.29095386119307015,0.9567251530513545,-0.004778302596747774,-0.9567370144838278,0.2909521343651026,-0.0010680004511185448]},"BodyRotation":{"TimeDependentFrames":[10014,1],"CkTableStartTime":392211095.6197291,"CkTableEndTime":392211113.1301291,"CkTableOriginalSize":57,"EphemerisTimes":[392211095.6197291,392211095.9324148,392211096.24510056,392211096.5577862,392211096.87047195,392211097.1831577,392211097.4958434,392211097.8085291,392211098.1212148,392211098.43390054,392211098.74658626,392211099.05927193,392211099.37195766,392211099.6846434,392211099.9973291,392211100.31001484,392211100.6227005,392211100.93538624,392211101.24807197,392211101.5607577,392211101.87344337,392211102.1861291,392211102.4988148,392211102.81150055,392211103.1241862,392211103.43687195,392211103.7495577,392211104.0622434,392211104.3749291,392211104.6876148,392211105.0003005,392211105.31298625,392211105.625672,392211105.93835765,392211106.2510434,392211106.5637291,392211106.87641484,392211107.1891005,392211107.50178623,392211107.81447196,392211108.1271577,392211108.43984336,392211108.7525291,392211109.0652148,392211109.37790054,392211109.69058627,392211110.00327194,392211110.31595767,392211110.6286434,392211110.9413291,392211111.2540148,392211111.5667005,392211111.87938625,392211112.192072,392211112.50475764,392211112.8174434,392211113.1301291],"Quaternions":[[-0.6613202993937386,0.31813079098385316,0.010572073619126085,0.6792175591790568],[-0.6613127723159941,0.3181309081232828,0.01056854811728733,0.6792248878383964],[-0.6613052451570344,0.3181310252236433,0.010565022614150708,0.6792322164143209],[-0.6612977179205667,0.3181311422848766,0.010561497111452716,0.6792395449032211],[-0.6612901905991795,0.3181312593070983,0.010557971605721531,0.679246873312313],[-0.6612826631978154,0.31813137629023136,0.010554446099272396,0.6792542016367846],[-0.6612751357127684,0.3181314932343333,0.010550920590369847,0.6792615298802435],[-0.6612676081489823,0.31813161013932756,0.010547395081328816,0.6792688580378768],[-0.6612600805052223,0.31813172700523323,0.010543869571571114,0.6792761861108871],[-0.6612525527777818,0.31813184383210774,0.01054034405936133,0.6792835141028821],[-0.6612450249691342,0.31813196061991283,0.010536818545856893,0.6792908420114546],[-0.6612374970792795,0.3181320773686484,0.010533293031058507,0.6792981698366042],[-0.6612299691094542,0.31813219407829546,0.010529767515545333,0.6793054975771274],[-0.6612224410571887,0.3181323107488921,0.010526241998160175,0.6793128252354281],[-0.6612149129249545,0.3181324273804,0.010522716480061124,0.6793201528091006],[-0.6612073847115173,0.31813254397283836,0.010519190960669701,0.6793274802993462],[-0.6611998564168776,0.31813266052620737,0.010515665439986516,0.6793348077061647],[-0.6611923280385654,0.3181327770405448,0.010512139916854547,0.67934213503196],[-0.6611847995815243,0.3181328935157747,0.010508614393588838,0.6793494622719204],[-0.6611772710432838,0.31813300995193483,0.010505088869032548,0.6793567894284505],[-0.6611697424250803,0.3181331263490063,0.01050156334376497,0.679364116500347],[-0.661162213723208,0.3181332427070463,0.010498037816050168,0.6793714434912166],[-0.661154684940139,0.31813335902601675,0.010494512287046127,0.6793787703986534],[-0.6611471560783456,0.31813347530587927,0.01049098675791083,0.6793860972202512],[-0.661139627132886,0.3181335915467105,0.0104874612263296,0.6793934239608193],[-0.6611320981062323,0.31813370774847205,0.010483935693460518,0.679400750617952],[-0.6611245689983857,0.31813382391116374,0.010480410159303837,0.679408077191648],[-0.6611170398105831,0.3181339400347667,0.0104768846244387,0.6794154036807039],[-0.6611095105415888,0.31813405611929996,0.010473359088287061,0.6794227300863217],[-0.6611019811901689,0.3181341721647827,0.010469833550270391,0.6794300564097027],[-0.6610944517587957,0.31813428817117634,0.010466308011546563,0.6794373826484408],[-0.6610869222449979,0.3181344041385194,0.010462782470958854,0.6794447088049408],[-0.6610793926500129,0.31813452006679277,0.010459256929086128,0.6794520348779984],[-0.6610718629775492,0.31813463595593927,0.010455731387664915,0.6794593608640059],[-0.6610643332201916,0.31813475180607304,0.010452205843223893,0.6794666867701777],[-0.6610568033804138,0.31813486761715587,0.010448680296920245,0.6794740125941068],[-0.6610492734619241,0.31813498338913093,0.010445154750490956,0.6794813383321856],[-0.6610417434622516,0.3181350991220363,0.010441629202778743,0.6794886639868178],[-0.6610342133826336,0.31813521481585266,0.010438103654362919,0.6794959895568002],[-0.6610266832193621,0.3181353304706371,0.010434578103507935,0.6795033150457395],[-0.6610191529749111,0.31813544608635175,0.010431052551371374,0.6795106404512293],[-0.6610116226492806,0.31813556166299645,0.010427526997953747,0.6795179657732693],[-0.661004092243708,0.31813567720055225,0.010424001443834393,0.679525291010656],[-0.6609965617569582,0.31813579269903813,0.010420475888434725,0.6795326161645907],[-0.6609890311877962,0.318135908158473,0.010416950331176619,0.6795399412362751],[-0.6609815005386944,0.31813602357881904,0.010413424773218069,0.6795472662233037],[-0.6609739698071824,0.318136138960114,0.010409899213401819,0.6795545911280799],[-0.6609664389944969,0.3181362543023389,0.010406373652307132,0.6795619159494005],[-0.6609589081031105,0.3181363696054561,0.01040284809109197,0.6795692406848608],[-0.6609513771280807,0.31813648486954105,0.010399322527441695,0.6795765653392678],[-0.6609438460743523,0.3181366000945182,0.010395796963671723,0.6795838899078124],[-0.6609363149369812,0.3181367152804631,0.010392271397467918,0.679591214395303],[-0.6609287837184417,0.3181368304273379,0.010388745829987592,0.679598538799333],[-0.6609212524174978,0.31813694553516153,0.010385220260652878,0.6796058631211048],[-0.6609137210403317,0.31813706060383956,0.010381694692357321,0.6796131873546056],[-0.6609061895782908,0.3181371756335041,0.010378169121050815,0.6796205115082505],[-0.660898658036321,0.3181372906240797,0.010374643549048585,0.6796278355772299]],"AngularVelocity":[[0.000031623595509944944,-0.000028807313539993838,0.00005651876115812607],[0.00003162359550994405,-0.000028807313540003663,0.0000565187611581216],[0.00003162359550994317,-0.000028807313540013485,0.000056518761158117075],[0.00003162359550994227,-0.000028807313540023277,0.00005651876115811258],[0.00003162359550994139,-0.000028807313540033103,0.00005651876115810806],[0.00003162359550994051,-0.000028807313540042925,0.00005651876115810357],[0.00003162359550993964,-0.000028807313540052727,0.000056518761158099084],[0.00003162359550993872,-0.000028807313540062542,0.000056518761158094564],[0.000031623595509937835,-0.000028807313540072375,0.000056518761158090065],[0.000031623595509936954,-0.000028807313540082146,0.00005651876115808552],[0.00003162359550993607,-0.000028807313540091985,0.00005651876115808103],[0.00003162359550993516,-0.00002880731354010179,0.00005651876115807652],[0.000031623595509934305,-0.0000288073135401116,0.00005651876115807202],[0.00003162359550993341,-0.000028807313540121425,0.00005651876115806753],[0.00003162359550993253,-0.000028807313540131216,0.00005651876115806301],[0.00003162359550993165,-0.000028807313540141042,0.00005651876115805853],[0.00003162359550993078,-0.000028807313540150837,0.00005651876115805401],[0.000031623595509929894,-0.00002880731354016063,0.00005651876115804951],[0.00003162359550992901,-0.000028807313540170444,0.00005651876115804499],[0.00003162359550992811,-0.000028807313540180276,0.00005651876115804049],[0.00003162359550992723,-0.000028807313540190068,0.000056518761158035984],[0.000031623595509926316,-0.000028807313540199877,0.000056518761158031464],[0.00003162359550992543,-0.000028807313540209706,0.00005651876115802698],[0.00003162359550992456,-0.000028807313540219497,0.000056518761158022485],[0.00003162359550992366,-0.00002880731354022932,0.00005651876115801795],[0.00003162359550992281,-0.000028807313540239135,0.000056518761158013466],[0.00003162359550992192,-0.000028807313540248944,0.00005651876115800896],[0.00003162359550992101,-0.000028807313540258766,0.000056518761158004454],[0.00003162359550992014,-0.00002880731354026855,0.00005651876115799993],[0.00003162359550991926,-0.00002880731354027839,0.000056518761157995455],[0.000031623595509918354,-0.0000288073135402882,0.000056518761157990935],[0.000031623595509917486,-0.000028807313540298,0.00005651876115798644],[0.00003162359550991658,-0.00002880731354030782,0.000056518761157981916],[0.000031623595509915704,-0.00002880731354031765,0.00005651876115797742],[0.00003162359550991484,-0.000028807313540327413,0.0000565187611579729],[0.000031623595509913956,-0.00002880731354033724,0.00005651876115796843],[0.00003162359550991306,-0.00002880731354034702,0.0000565187611579639],[0.00003162359550991219,-0.000028807313540356866,0.00005651876115795941],[0.0000316235955099113,-0.00002880731354036668,0.0000565187611579549],[0.00003162359550991041,-0.000028807313540376466,0.00005651876115795039],[0.000031623595509909524,-0.000028807313540386305,0.00005651876115794591],[0.00003162359550990863,-0.00002880731354039612,0.00005651876115794138],[0.000031623595509907756,-0.000028807313540405923,0.00005651876115793689],[0.000031623595509906854,-0.00002880731354041573,0.000056518761157932375],[0.000031623595509905967,-0.000028807313540425564,0.0000565187611579279],[0.00003162359550990509,-0.000028807313540435345,0.000056518761157923355],[0.000031623595509904205,-0.00002880731354044517,0.00005651876115791887],[0.00003162359550990328,-0.000028807313540454993,0.00005651876115791436],[0.00003162359550990244,-0.00002880731354046479,0.00005651876115790987],[0.00003162359550990152,-0.000028807313540474603,0.00005651876115790532],[0.00003162359550990063,-0.000028807313540484426,0.0000565187611579008],[0.00003162359550989979,-0.000028807313540494197,0.00005651876115789631],[0.00003162359550989889,-0.00002880731354050402,0.00005651876115789179],[0.00003162359550989803,-0.00002880731354051382,0.00005651876115788733],[0.000031623595509897124,-0.000028807313540523643,0.000056518761157882806],[0.00003162359550989623,-0.00002880731354053345,0.000056518761157878286],[0.000031623595509895355,-0.00002880731354054326,0.0000565187611578738]]},"InstrumentPosition":{"SpkTableStartTime":392211095.6197291,"SpkTableEndTime":392211113.1301291,"SpkTableOriginalSize":57,"EphemerisTimes":[392211095.6197291,392211095.9324148,392211096.24510056,392211096.5577862,392211096.87047195,392211097.1831577,392211097.4958434,392211097.8085291,392211098.1212148,392211098.43390054,392211098.74658626,392211099.05927193,392211099.37195766,392211099.6846434,392211099.9973291,392211100.31001484,392211100.6227005,392211100.93538624,392211101.24807197,392211101.5607577,392211101.87344337,392211102.1861291,392211102.4988148,392211102.81150055,392211103.1241862,392211103.43687195,392211103.7495577,392211104.0622434,392211104.3749291,392211104.6876148,392211105.0003005,392211105.31298625,392211105.625672,392211105.93835765,392211106.2510434,392211106.5637291,392211106.87641484,392211107.1891005,392211107.50178623,392211107.81447196,392211108.1271577,392211108.43984336,392211108.7525291,392211109.0652148,392211109.37790054,392211109.69058627,392211110.00327194,392211110.31595767,392211110.6286434,392211110.9413291,392211111.2540148,392211111.5667005,392211111.87938625,392211112.192072,392211112.50475764,392211112.8174434,392211113.1301291],"Positions":[[87.5466120113472,3034.785875639327,2293.0758126687438],[87.1259853877253,3035.3657391676393,2292.3096302970416],[86.70535258763341,3035.94537053045,2291.5432724525185],[86.2847124786048,3036.524771515897,2290.7767406402554],[85.8640661931181,3037.1039403507207,2290.010033303032],[85.4434125390969,3037.682878837958,2289.24315196828],[85.0227528576515,3038.2615849659037,2288.4760953917116],[84.60208601631265,3038.840060522697,2287.708865063508],[84.18141308795352,3039.4183037648786,2286.9414594636996],[83.76073299971182,3039.99631645078,2286.1738800824646],[83.34004694367677,3040.574096613407,2285.4061256755185],[82.9193538767951,3041.1516460110906,2284.638197762842],[82.49865484213038,3041.728962900372,2283.870094802117],[82.07794876682782,3042.3060490693883,2283.1018182909684],[81.65723687277513,3042.8829025362393,2282.3333670000156],[81.23651796789723,3043.4595251486803,2281.5647422629686],[80.81579342310806,3044.0359148502866,2280.795943014363],[80.39506189731497,3044.6120737570614,2280.0269702973205],[79.97432467200753,3045.1879997529777,2279.2578230240283],[79.55358058492338,3045.763694730495,2278.4885025431],[79.13283097716781,3046.339156633196,2277.7190077741643],[78.71207450764463,3046.91438753237,2276.9493397677984],[78.29131245785375,3047.489385371605,2276.179497436189],[77.87054366552405,3048.064151983748,2275.4094821353965],[77.4497694717638,3048.6386853421855,2274.639292755253],[77.02898856528296,3049.2129875331125,2273.8689303835854],[76.6082022573793,3049.7870564554028,2273.0983939176776],[76.18740929637465,3050.360893956817,2272.327684698692],[75.76661108298512,3050.934498055438,2271.5568016537113],[75.34580627611257,3051.507870748055,2270.7857458333133],[74.92499615725811,3052.0810100378567,2270.0145161422292],[74.50417953434598,3052.65391774279,2269.243113951425],[74.08335768887675,3053.2265919256592,2268.471538009163],[73.66252951818723,3053.7990343298998,2267.6997898130753],[73.24169615475485,3054.3712432418506,2266.9278678357373],[72.82085643630812,3054.943220375146,2266.1557735822344],[72.40001098870329,3055.5149647760804,2265.383506463956],[71.97916052719602,3056.0864752972216,2264.6110660189584],[71.55830380010774,3056.6577540396606,2263.838453320166],[71.13744202932838,3057.2287989320816,2263.0656672723153],[70.71657405259006,3057.7996118669407,2262.292709238918],[70.29570124079811,3058.3701907282157,2261.519578132159],[69.8748222826671,3058.940537661704,2260.74627499516],[69.45393840008438,3059.5106505364843,2259.9727987550123],[69.0330484605849,3060.080531259915,2259.1991507305206],[68.61215374566926,3060.6501778798947,2258.4253297221035],[68.19125309306442,3061.219592110057,2257.6513372124937],[67.77034763525124,3061.788772251646,2256.8771716891697],[67.34943623975961,3062.357720048096,2256.102834627411],[66.92852012848662,3062.9264335473085,2255.328324782932],[66.50759828817728,3063.494914507616,2254.5536436980674],[66.08667173209463,3064.0631611855633,2253.7787898006923],[65.66573938738179,3064.6311753245814,2253.0037646182423],[65.24480250573303,3065.1989549874756,2252.2285668840773],[64.82385998448727,3065.7665019474766,2251.453198140532],[64.40291283690243,3066.3338144164304,2250.6776568080354],[63.98196007953803,3066.900894197368,2249.901944428918]],"Velocities":[[-1.345193813965703,1.8548292421158314,-2.450048685058793],[-1.34521561016394,1.8540899364159005,-2.450607890725693],[-1.3452373034953327,1.8533504828862126,-2.451166913273489],[-1.345258893944468,1.852610882004493,-2.451725752336377],[-1.345280381524181,1.851871133261908,-2.452284408294042],[-1.3453017662191364,1.8511312371363058,-2.452842880780827],[-1.3453230480338598,1.850391193400703,-2.4534011699632576],[-1.3453442269532225,1.8496510025332622,-2.4539592754759956],[-1.3453653029897599,1.8489106640247195,-2.454517197698245],[-1.3453862761284192,1.8481701783533449,-2.455074936264805],[-1.3454071463736033,1.8474295452919791,-2.455632491341985],[-1.3454279137104377,1.8466887653191728,-2.4561898625649285],[-1.345448578151211,1.8459478379252834,-2.456747050312323],[-1.3454691396811043,1.8452067635889593,-2.457304054219446],[-1.3454895983044177,1.844465542082879,-2.457860874452385],[-1.3455099540104205,1.8437241737446544,-2.4584175107528408],[-1.345530206799483,1.8429826584882494,-2.458973963180738],[-1.3455503566686933,1.8422409963686965,-2.4595302316900938],[-1.3455704036183518,1.8414991872998658,-2.460086316340675],[-1.3455903476379099,1.8407572316196195,-2.460642216874526],[-1.345610188727704,1.8400151292418887,-2.4611979333514857],[-1.3456299268848495,1.8392728802217457,-2.4617534657256197],[-1.345649562109601,1.8385304844730121,-2.462308814056621],[-1.345669094391605,1.8377879423338397,-2.462863978086872],[-1.3456885237311593,1.8370452537180861,-2.4634189578761143],[-1.3457078501254063,1.8363024186808974,-2.4639737533784745],[-1.3457270735745521,1.8355594371360378,-2.4645283646535705],[-1.3457461940684445,1.8348163094219172,-2.465082791444093],[-1.3457652116073227,1.8340730354523644,-2.4656370338097333],[-1.3457841261883745,1.8333296152825684,-2.4661910917046557],[-1.3458029378117606,1.8325860488262347,-2.46674496518839],[-1.3458216464675163,1.8318423364220748,-2.467298654003984],[-1.3458402521593775,1.8310984778420272,-2.4678521583165067],[-1.3458587548739462,1.8303544735667745,-2.468405477763731],[-1.3458771546219612,1.829610323084545,-2.46895861272156],[-1.3458954513900983,1.828866026876123,-2.469511562827887],[-1.3459136451786722,1.8281215848551609,-2.4700643281422763],[-1.3459317359844785,1.8273769970771352,-2.470616908618844],[-1.3459497238047822,1.826632263597391,-2.471169304211891],[-1.3459676086396457,1.8258873843294963,-2.471721514980749],[-1.345985390479522,1.8251423596127787,-2.4722735406692293],[-1.3460030693245235,1.8243971893608872,-2.4728253813367247],[-1.3460206451719328,1.8236518736291776,-2.4733770369376],[-1.3460381180217769,1.8229064123312027,-2.4739285075310935],[-1.3460554878647029,1.8221608058065415,-2.474479792861361],[-1.3460727547040625,1.821415053826631,-2.4750308930927414],[-1.3460899185273187,1.8206691568734041,-2.475581807864553],[-1.3461069793443046,1.8199231144338126,-2.476132537551054],[-1.346123937142576,1.8191769269899367,-2.476683081791701],[-1.3461407919253545,1.818430594313002,-2.4772334407506142],[-1.3461575436803888,1.8176841168853524,-2.4777836140675826],[-1.3461741924172148,1.8169374941935403,-2.4783336021163707],[-1.3461907381236728,1.8161907267200352,-2.4788834045368953],[-1.3462071808028442,1.8154438142358928,-2.479433021493061],[-1.346223520442756,1.8146967572238528,-2.479982452625143],[-1.3462397570526723,1.8139495551700975,-2.480531698306386],[-1.3462558906206838,1.8132022085574493,-2.481080758177203]]},"SunPosition":{"SpkTableStartTime":392211104.3749291,"SpkTableEndTime":392211104.3749291,"SpkTableOriginalSize":1,"EphemerisTimes":[392211104.3749291],"Positions":[[216567373.63082,97116441.68696342,38695554.149745286]],"Velocities":[[-11.437829189465381,17.84743252135627,8.495026001915337]]}
        }
    },
    "I74199019RDR" : {
        "isis" : {
            "CameraVersion": 1,
            "NaifKeywords": {
                "BODY499_RADII": [
                    3396.19,
                    3396.19,
                    3376.2
                ],
                "BODY_FRAME_CODE": 10014,
                "BODY_CODE": 499,
                "TKFRAME_-53031_RELATIVE": "M01_THEMIS_OPTICS",
                "TKFRAME_-53031_UNITS": "DEGREES",
                "INS-53031_CK_FRAME_ID": -53000.0,
                "INS-53031_CK_TIME_BIAS": 0.0,
                "INS-53031_ITRANSL": [
                    0.0,
                    0.0,
                    20.0
                ],
                "INS-53031_ITRANSS": [
                    0.0,
                    20.0,
                    0.0
                ],
                "TKFRAME_-53031_ANGLES": [
                    -0.1701,
                    90.05331,
                    -0.6315
                ],
                "INS-53031_CK_TIME_TOLERANCE": 1.0,
                "FRAME_-53031_CENTER": -53.0,
                "FRAME_-53031_NAME": "M01_THEMIS_IR",
                "TKFRAME_-53031_AXES": [
                    3.0,
                    2.0,
                    3.0
                ],
                "TKFRAME_-53031_SPEC": "ANGLES",
                "INS-53031_TRANSX": [
                    0.0,
                    0.05,
                    0.0
                ],
                "INS-53031_TRANSY": [
                    0.0,
                    0.0,
                    0.05
                ],
                "INS-53031_PLATFORM_ID": -53000.0,
                "FRAME_-53031_CLASS_ID": -53031.0,
                "INS-53031_CK_REFERENCE_ID": 16.0,
                "FRAME_-53031_CLASS": 4.0,
                "INS-53031_SPK_TIME_BIAS": 0.0,
                "BODY499_POLE_DEC": [
                    52.8865,
                    -0.0609,
                    0.0
                ],
                "BODY499_POLE_RA": [
                    317.68143,
                    -0.1061,
                    0.0
                ],
                "BODY499_PM": [
                    176.63,
                    350.89198226,
                    0.0
                ]
            },
            "InstrumentPointing": {
                "TimeDependentFrames": [
                    -53000,
                    16,
                    1
                ],
                "CkTableStartTime": 589445676.9899044,
                "CkTableEndTime": 589445686.0439956,
                "CkTableOriginalSize": 4,
                "EphemerisTimes": [
                    589445676.9899044,
                    589445680.0079348,
                    589445683.0259652,
                    589445686.0439956
                ],
                "Quaternions": [
                    [
                        0.38598147685908185,
                        -0.5607948046031743,
                        -0.6866376818635513,
                        -0.2550611309016295
                    ],
                    [
                        0.38562579307122824,
                        -0.5617138648879078,
                        -0.6858904675855092,
                        -0.25558667450829115
                    ],
                    [
                        0.38527060742872654,
                        -0.5626353429020607,
                        -0.6851390429149169,
                        -0.25611037043160223
                    ],
                    [
                        0.3849151928868023,
                        -0.563557151464003,
                        -0.6843852032119891,
                        -0.25663305504782297
                    ]
                ],
                "AngularVelocity": [
                    [
                        0.0007324350225698707,
                        -6.952577687208014e-05,
                        -0.0005029467858822215
                    ],
                    [
                        0.0007335508142603166,
                        -6.91981129943357e-05,
                        -0.0005044432717278556
                    ],
                    [
                        0.0007368387903980461,
                        -3.32990142650248e-05,
                        -0.0004221206727530788
                    ],
                    [
                        0.0007393253232865181,
                        -7.2290602625411406e-06,
                        -0.0003625424840601517
                    ]
                ],
                "ConstantFrames": [
                    -53031,
                    -53030,
                    -53000
                ],
                "ConstantRotation": [
                    0.0013835021734054376,
                    0.01152997618685378,
                    0.9999325705120657,
                    0.2881133069543266,
                    0.9575279926584919,
                    -0.011439651709813592,
                    -0.957595325948064,
                    0.288109706404575,
                    -0.0019971975093594496
                ]
            },
            "BodyRotation": {
                "TimeDependentFrames": [
                    10014,
                    1
                ],
                "CkTableStartTime": 589445676.9899044,
                "CkTableEndTime": 589445686.0439956,
                "CkTableOriginalSize": 4,
                "EphemerisTimes": [
                    589445676.9899044,
                    589445680.0079348,
                    589445683.0259652,
                    589445686.0439956
                ],
                "Quaternions": [
                    [
                        -0.5408451126894908,
                        0.31557698159693326,
                        -0.04183520300757272,
                        0.7785547819873538
                    ],
                    [
                        -0.5407618335951139,
                        0.3155725050030793,
                        -0.041868957604701294,
                        0.7786126275639432
                    ],
                    [
                        -0.5406785483110855,
                        0.3155680247986294,
                        -0.04190271172395818,
                        0.7786704642344462
                    ],
                    [
                        -0.5405952568468566,
                        0.31556354098409234,
                        -0.04193646536151294,
                        0.7787282919923001
                    ]
                ],
                "AngularVelocity": [
                    [
                        3.162303650185794e-05,
                        -2.8813502069024346e-05,
                        5.651591926299394e-05
                    ],
                    [
                        3.1623036501849386e-05,
                        -2.8813502069119034e-05,
                        5.651591926295044e-05
                    ],
                    [
                        3.162303650184082e-05,
                        -2.8813502069213752e-05,
                        5.6515919262906996e-05
                    ],
                    [
                        3.162303650183226e-05,
                        -2.8813502069308437e-05,
                        5.6515919262863486e-05
                    ]
                ]
            },
            "InstrumentPosition": {
                "SpkTableStartTime": 589445676.9899044,
                "SpkTableEndTime": 589445686.0439956,
                "SpkTableOriginalSize": 4,
                "EphemerisTimes": [
                    589445676.9899044,
                    589445680.0079348,
                    589445683.0259652,
                    589445686.0439956
                ],
                "Positions": [
                    [
                        -883.3647639832787,
                        3235.9253823963995,
                        -1734.2678063014955
                    ],
                    [
                        -878.0820172062348,
                        3241.143181714679,
                        -1727.2955108387216
                    ],
                    [
                        -872.7929026970128,
                        3246.3375924365314,
                        -1720.3106940936013
                    ],
                    [
                        -867.4974605099152,
                        3251.5085747718745,
                        -1713.3134080300226
                    ]
                ],
                "Velocities": [
                    [
                        1.7493370110442228,
                        1.7327474299014805,
                        2.308134335038546
                    ],
                    [
                        1.7514526413807416,
                        1.7250030655476496,
                        2.312291077819496
                    ],
                    [
                        1.7535556099591456,
                        1.7172463879119024,
                        2.316431067882768
                    ],
                    [
                        1.7556459015231667,
                        1.7094774543366804,
                        2.3205542750988553
                    ]
                ]
            },
            "SunPosition": {
                "SpkTableStartTime": 589445681.51695,
                "SpkTableEndTime": 589445681.51695,
                "SpkTableOriginalSize": 1,
                "EphemerisTimes": [
                    589445681.51695
                ],
                "Positions": [
                    [
                        -177834612.75017235,
                        94014077.38389017,
                        47921572.85876171
                    ]
                ],
                "Velocities": [
                    [
                        -13.267042406345718,
                        -20.96669045246765,
                        -9.258799613448325
                    ]
                ]
            }
          }
        }
      }


@pytest.fixture()
def test_themisir_kernels():
    kernels = get_image_kernels('I74199019RDR')
    updated_kernels, binary_kernels = convert_kernels(kernels)
    yield updated_kernels
    for kern in binary_kernels:
        os.remove(kern)

@pytest.fixture()
def test_themisvis_kernels():
    kernels = get_image_kernels('V46475015EDR')
    updated_kernels, binary_kernels = convert_kernels(kernels)
    yield updated_kernels
    for kern in binary_kernels:
        os.remove(kern)

@pytest.mark.parametrize("label_type", ['isis3'])
@pytest.mark.parametrize("formatter", ['isis'])
def test_themisir_load(test_themisir_kernels, label_type, formatter):
    label_file = get_image_label('I74199019RDR', label_type)
    usgscsm_isd_str = ale.loads(label_file, props={'kernels': test_themisir_kernels}, formatter=formatter)
    usgscsm_isd_obj = json.loads(usgscsm_isd_str)
    print(json.dumps(usgscsm_isd_obj, indent=4))

    assert compare_dicts(usgscsm_isd_obj, image_dict["I74199019RDR"][formatter]) == []

@pytest.mark.parametrize("label_type", ['isis3'])
@pytest.mark.parametrize("formatter", ['isis'])
def test_themisvis_load(test_themisvis_kernels, label_type, formatter):
    label_file = get_image_label('V46475015EDR', label_type)
    usgscsm_isd_str = ale.loads(label_file, props={'kernels': test_themisvis_kernels}, formatter=formatter)
    usgscsm_isd_obj = json.loads(usgscsm_isd_str)
    print(json.dumps(usgscsm_isd_obj, indent=4))

    assert compare_dicts(usgscsm_isd_obj, image_dict["V46475015EDR"][formatter]) == []


class test_themisir_isis_naif(unittest.TestCase):
    def setUp(self):
        label = get_image_label("I74199019RDR", "isis3")
        self.driver = OdyThemisIrIsisLabelNaifSpiceDriver(label)

    def test_instrument_id(self):
        assert self.driver.instrument_id == "THEMIS_IR"

    def test_spacecraft_name(self):
        assert self.driver.spacecraft_name == "MARS ODYSSEY"

    def test_line_exposure_duration(self):
        assert self.driver.line_exposure_duration == 0.0332871

    def test_ephemeris_start_time(self):
        with patch('ale.drivers.ody_drivers.spice.scs2e', return_value=0) as scs2e:
            self.driver.label["IsisCube"]["Instrument"]["SpacecraftClockOffset"] = 10
            assert self.driver.ephemeris_start_time == 10

    def test_sensor_model_version(self):
        assert self.driver.sensor_model_version == 1

class test_themisvis_isis_naif(unittest.TestCase):
    def setUp(self):
        label = get_image_label("V46475015EDR", "isis3")
        self.driver = OdyThemisVisIsisLabelNaifSpiceDriver(label)

    def test_instrument_id(self):
        assert self.driver.instrument_id == "THEMIS_VIS"

    def test_spacecraft_name(self):
        assert self.driver.spacecraft_name == "MARS ODYSSEY"

    def test_line_exposure_duration(self):
        assert self.driver.line_exposure_duration == 0.0048

    def test_ephemeris_start_time(self):
        with patch('ale.drivers.mro_drivers.spice.scs2e', return_value=0) as scs2e:
            self.driver.label["IsisCube"]["Instrument"]["SpacecraftClockOffset"] = 10
            assert self.driver.ephemeris_start_time == (10 - self.driver.line_exposure_duration/2)

    def test_sensor_model_version(self):
        assert self.driver.sensor_model_version == 1

